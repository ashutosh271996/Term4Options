{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "26a1c3af",
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/ashutoshaggawal27/Library/Python/3.8/lib/python/site-packages/IPython/core/interactiveshell.py:3441: DtypeWarning: Columns (3,5,6,7,8,9,10,11,12,13) have mixed types.Specify dtype option on import or set low_memory=False.\n",
      "  exec(code_obj, self.user_global_ns, self.user_ns)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "6044\n",
      "122524\n",
      "          SYMBOL  TIMESTAMP STOCK_OPEN STOCK_HIGH STOCK_LOW STOCK_CLOSE  \\\n",
      "0      20MICRONS 2019-09-03       33.0       33.4      32.5       33.15   \n",
      "1     21STCENMGM 2019-09-03       12.3       12.3      12.3        12.3   \n",
      "2     3IINFOTECH 2019-09-03       1.75       1.75       1.7         1.7   \n",
      "3        3MINDIA 2019-09-03    20349.0    21000.0   20000.0    20098.95   \n",
      "4         3PLAND 2019-09-03        6.0        6.3       6.0         6.3   \n",
      "...          ...        ...        ...        ...       ...         ...   \n",
      "6042   ZODJRDMKJ 2019-09-06      31.05       32.0     31.05       31.35   \n",
      "6043        ZOTA 2019-09-06      185.0     188.95     181.7      187.25   \n",
      "6044       ZUARI 2019-09-06      98.65     101.65      98.2       98.65   \n",
      "6045   ZUARIGLOB 2019-09-06      64.75      65.65     64.15        65.4   \n",
      "6046   ZYDUSWELL 2019-09-06     1680.0     1695.9   1672.85      1680.2   \n",
      "\n",
      "     STOCK_TOTTRDQTY STOCK_DELIVERABLE  \n",
      "0              16196              7762  \n",
      "1                164               164  \n",
      "2             508178            316341  \n",
      "3               7637              6100  \n",
      "4                199               199  \n",
      "...              ...               ...  \n",
      "6042             101                51  \n",
      "6043           73814             52322  \n",
      "6044           30938             17199  \n",
      "6045           43148             29123  \n",
      "6046            5195              3669  \n",
      "\n",
      "[6044 rows x 8 columns]\n",
      "       INSTRUMENT SYMBOL    EXPIRY_DT STRIKE_PR OPTION_TYP OPEN HIGH  LOW  \\\n",
      "0          OPTSTK    ACC  26-Sep-2019    1260.0         CE  0.0  0.0  0.0   \n",
      "1          OPTSTK    ACC  26-Sep-2019    1280.0         CE  0.0  0.0  0.0   \n",
      "2          OPTSTK    ACC  26-Sep-2019    1300.0         CE  0.0  0.0  0.0   \n",
      "3          OPTSTK    ACC  26-Sep-2019    1320.0         CE  0.0  0.0  0.0   \n",
      "4          OPTSTK    ACC  26-Sep-2019    1340.0         CE  0.0  0.0  0.0   \n",
      "...           ...    ...          ...       ...        ...  ...  ...  ...   \n",
      "122519     OPTSTK   ZEEL  28-Nov-2019     440.0         PE  0.0  0.0  0.0   \n",
      "122520     OPTSTK   ZEEL  28-Nov-2019     450.0         PE  0.0  0.0  0.0   \n",
      "122521     OPTSTK   ZEEL  28-Nov-2019     460.0         PE  0.0  0.0  0.0   \n",
      "122522     OPTSTK   ZEEL  28-Nov-2019     470.0         PE  0.0  0.0  0.0   \n",
      "122523     OPTSTK   ZEEL  28-Nov-2019     480.0         PE  0.0  0.0  0.0   \n",
      "\n",
      "         CLOSE SETTLE_PR CONTRACTS VAL_INLAKH OPEN_INT CHG_IN_OI  TIMESTAMP  \n",
      "0       350.75    200.95         0        0.0        0         0 2019-09-03  \n",
      "1       333.05    183.05         0        0.0        0         0 2019-09-03  \n",
      "2        315.7    165.75         0        0.0        0         0 2019-09-03  \n",
      "3       298.75     149.1         0        0.0        0         0 2019-09-03  \n",
      "4       282.15    133.25         0        0.0        0         0 2019-09-03  \n",
      "...        ...       ...       ...        ...      ...       ...        ...  \n",
      "122519    91.8     87.45         0        0.0        0         0 2019-09-06  \n",
      "122520    99.5      95.4         0        0.0        0         0 2019-09-06  \n",
      "122521   107.4     103.6         0        0.0        0         0 2019-09-06  \n",
      "122522   115.5     112.0         0        0.0        0         0 2019-09-06  \n",
      "122523  123.75    120.55         0        0.0        0         0 2019-09-06  \n",
      "\n",
      "[122524 rows x 15 columns]\n",
      "SYMBOL                       object\n",
      "TIMESTAMP            datetime64[ns]\n",
      "STOCK_OPEN                   object\n",
      "STOCK_HIGH                   object\n",
      "STOCK_LOW                    object\n",
      "STOCK_CLOSE                  object\n",
      "STOCK_TOTTRDQTY              object\n",
      "STOCK_DELIVERABLE            object\n",
      "dtype: object\n",
      "INSTRUMENT            object\n",
      "SYMBOL                object\n",
      "EXPIRY_DT             object\n",
      "STRIKE_PR             object\n",
      "OPTION_TYP            object\n",
      "OPEN                  object\n",
      "HIGH                  object\n",
      "LOW                   object\n",
      "CLOSE                 object\n",
      "SETTLE_PR             object\n",
      "CONTRACTS             object\n",
      "VAL_INLAKH            object\n",
      "OPEN_INT              object\n",
      "CHG_IN_OI             object\n",
      "TIMESTAMP     datetime64[ns]\n",
      "dtype: object\n"
     ]
    }
   ],
   "source": [
    "from datetime import datetime\n",
    "from dateutil.relativedelta import relativedelta\n",
    "import  zipfile, os, io\n",
    "import requests\n",
    "import pandas as pd\n",
    "import sys\n",
    "import datetime\n",
    "from dateutil.parser import parse\n",
    "import mibian\n",
    "import scipy\n",
    "\n",
    "stocks_data= pd.read_csv ('/Users/ashutoshaggawal27/Documents/Term4/ProjectCourse/Term4Options/dataset/stocks.csv')\n",
    "futures_data= pd.read_csv ('/Users/ashutoshaggawal27/Documents/Term4/ProjectCourse/Term4Options/dataset/futures.csv')\n",
    "stocks_data=stocks_data.loc[stocks_data['SYMBOL'] != \"SYMBOL\"]\n",
    "futures_data=futures_data.loc[futures_data['SYMBOL'] != \"SYMBOL\"]\n",
    "\n",
    "\n",
    "stocks_data.rename(columns={'OPEN': 'STOCK_OPEN', 'HIGH': 'STOCK_HIGH','LOW': 'STOCK_LOW','CLOSE': 'STOCK_CLOSE','TOTTRDQTY': 'STOCK_TOTTRDQTY','DELIVERABLE': 'STOCK_DELIVERABLE'}, inplace=True)\n",
    "futures_data.drop(futures_data.columns[futures_data.columns.str.contains('unnamed',case = False)],axis = 1, inplace = True)\n",
    "futures_data=futures_data.loc[futures_data['INSTRUMENT'] == \"OPTSTK\"]\n",
    "futures_data.reset_index(drop=True, inplace=True)\n",
    "stocks_data = stocks_data.astype(str)\n",
    "futures_data = futures_data.astype(str)\n",
    "\n",
    "futures_data.TIMESTAMP=futures_data.TIMESTAMP.apply(lambda x : parse(x))\n",
    "stocks_data.TIMESTAMP=stocks_data.TIMESTAMP.apply(lambda x : parse(x))\n",
    "\n",
    "print(len(stocks_data))\n",
    "print(len(futures_data))\n",
    "print(stocks_data)\n",
    "print(futures_data)\n",
    "print(stocks_data.dtypes)\n",
    "print(futures_data.dtypes)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "ed29b1f7",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "       INSTRUMENT SYMBOL    EXPIRY_DT STRIKE_PR OPTION_TYP OPEN HIGH  LOW  \\\n",
      "0          OPTSTK    ACC  26-Sep-2019    1260.0         CE  0.0  0.0  0.0   \n",
      "1          OPTSTK    ACC  26-Sep-2019    1280.0         CE  0.0  0.0  0.0   \n",
      "2          OPTSTK    ACC  26-Sep-2019    1300.0         CE  0.0  0.0  0.0   \n",
      "3          OPTSTK    ACC  26-Sep-2019    1320.0         CE  0.0  0.0  0.0   \n",
      "4          OPTSTK    ACC  26-Sep-2019    1340.0         CE  0.0  0.0  0.0   \n",
      "...           ...    ...          ...       ...        ...  ...  ...  ...   \n",
      "122519     OPTSTK   ZEEL  28-Nov-2019     440.0         PE  0.0  0.0  0.0   \n",
      "122520     OPTSTK   ZEEL  28-Nov-2019     450.0         PE  0.0  0.0  0.0   \n",
      "122521     OPTSTK   ZEEL  28-Nov-2019     460.0         PE  0.0  0.0  0.0   \n",
      "122522     OPTSTK   ZEEL  28-Nov-2019     470.0         PE  0.0  0.0  0.0   \n",
      "122523     OPTSTK   ZEEL  28-Nov-2019     480.0         PE  0.0  0.0  0.0   \n",
      "\n",
      "         CLOSE SETTLE_PR  ... VAL_INLAKH OPEN_INT CHG_IN_OI  TIMESTAMP  \\\n",
      "0       350.75    200.95  ...        0.0        0         0 2019-09-03   \n",
      "1       333.05    183.05  ...        0.0        0         0 2019-09-03   \n",
      "2        315.7    165.75  ...        0.0        0         0 2019-09-03   \n",
      "3       298.75     149.1  ...        0.0        0         0 2019-09-03   \n",
      "4       282.15    133.25  ...        0.0        0         0 2019-09-03   \n",
      "...        ...       ...  ...        ...      ...       ...        ...   \n",
      "122519    91.8     87.45  ...        0.0        0         0 2019-09-06   \n",
      "122520    99.5      95.4  ...        0.0        0         0 2019-09-06   \n",
      "122521   107.4     103.6  ...        0.0        0         0 2019-09-06   \n",
      "122522   115.5     112.0  ...        0.0        0         0 2019-09-06   \n",
      "122523  123.75    120.55  ...        0.0        0         0 2019-09-06   \n",
      "\n",
      "       STOCK_OPEN STOCK_HIGH STOCK_LOW STOCK_CLOSE STOCK_TOTTRDQTY  \\\n",
      "0          1500.0    1503.95    1440.0      1451.3         1309422   \n",
      "1          1500.0    1503.95    1440.0      1451.3         1309422   \n",
      "2          1500.0    1503.95    1440.0      1451.3         1309422   \n",
      "3          1500.0    1503.95    1440.0      1451.3         1309422   \n",
      "4          1500.0    1503.95    1440.0      1451.3         1309422   \n",
      "...           ...        ...       ...         ...             ...   \n",
      "122519     361.75      366.8    358.65      361.25         2378166   \n",
      "122520     361.75      366.8    358.65      361.25         2378166   \n",
      "122521     361.75      366.8    358.65      361.25         2378166   \n",
      "122522     361.75      366.8    358.65      361.25         2378166   \n",
      "122523     361.75      366.8    358.65      361.25         2378166   \n",
      "\n",
      "       STOCK_DELIVERABLE  \n",
      "0                 567551  \n",
      "1                 567551  \n",
      "2                 567551  \n",
      "3                 567551  \n",
      "4                 567551  \n",
      "...                  ...  \n",
      "122519            395918  \n",
      "122520            395918  \n",
      "122521            395918  \n",
      "122522            395918  \n",
      "122523            395918  \n",
      "\n",
      "[122524 rows x 21 columns]\n"
     ]
    }
   ],
   "source": [
    "result_data = pd.merge(futures_data, stocks_data, how='left', on=['SYMBOL', 'TIMESTAMP'])\n",
    "print(result_data)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "2a13b33e",
   "metadata": {},
   "outputs": [],
   "source": [
    "r=0.04\n",
    "\n",
    "def compute_DAYS_TO_EXP (row):\n",
    "   return (parse(row[\"EXPIRY_DT\"])-row[\"TIMESTAMP\"]).days\n",
    "\n",
    "def compute_IV (row):  \n",
    "   if row['OPTION_TYP'] == \"CE\" :\n",
    "      return mibian.BS([row[\"STOCK_CLOSE\"], row[\"STRIKE_PR\"],r, row[\"DAYS_TO_EXP\"]], callPrice=row[\"CLOSE\"] ).impliedVolatility\n",
    "   return  mibian.BS([row[\"STOCK_CLOSE\"], row[\"STRIKE_PR\"],r, row[\"DAYS_TO_EXP\"]], putPrice=row[\"CLOSE\"] ).impliedVolatility\n",
    "\n",
    "def compute_DELTA (row):  \n",
    "   return  mibian.BS([row[\"STOCK_CLOSE\"], row[\"STRIKE_PR\"],r, row[\"DAYS_TO_EXP\"]], volatility=row[\"IV\"] ).callDelta\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "61657a84",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "       INSTRUMENT SYMBOL    EXPIRY_DT STRIKE_PR OPTION_TYP OPEN HIGH  LOW  \\\n",
      "0          OPTSTK    ACC  26-Sep-2019    1260.0         CE  0.0  0.0  0.0   \n",
      "1          OPTSTK    ACC  26-Sep-2019    1280.0         CE  0.0  0.0  0.0   \n",
      "2          OPTSTK    ACC  26-Sep-2019    1300.0         CE  0.0  0.0  0.0   \n",
      "3          OPTSTK    ACC  26-Sep-2019    1320.0         CE  0.0  0.0  0.0   \n",
      "4          OPTSTK    ACC  26-Sep-2019    1340.0         CE  0.0  0.0  0.0   \n",
      "...           ...    ...          ...       ...        ...  ...  ...  ...   \n",
      "122519     OPTSTK   ZEEL  28-Nov-2019     440.0         PE  0.0  0.0  0.0   \n",
      "122520     OPTSTK   ZEEL  28-Nov-2019     450.0         PE  0.0  0.0  0.0   \n",
      "122521     OPTSTK   ZEEL  28-Nov-2019     460.0         PE  0.0  0.0  0.0   \n",
      "122522     OPTSTK   ZEEL  28-Nov-2019     470.0         PE  0.0  0.0  0.0   \n",
      "122523     OPTSTK   ZEEL  28-Nov-2019     480.0         PE  0.0  0.0  0.0   \n",
      "\n",
      "         CLOSE SETTLE_PR  ... OPEN_INT CHG_IN_OI  TIMESTAMP STOCK_OPEN  \\\n",
      "0       350.75    200.95  ...        0         0 2019-09-03     1500.0   \n",
      "1       333.05    183.05  ...        0         0 2019-09-03     1500.0   \n",
      "2        315.7    165.75  ...        0         0 2019-09-03     1500.0   \n",
      "3       298.75     149.1  ...        0         0 2019-09-03     1500.0   \n",
      "4       282.15    133.25  ...        0         0 2019-09-03     1500.0   \n",
      "...        ...       ...  ...      ...       ...        ...        ...   \n",
      "122519    91.8     87.45  ...        0         0 2019-09-06     361.75   \n",
      "122520    99.5      95.4  ...        0         0 2019-09-06     361.75   \n",
      "122521   107.4     103.6  ...        0         0 2019-09-06     361.75   \n",
      "122522   115.5     112.0  ...        0         0 2019-09-06     361.75   \n",
      "122523  123.75    120.55  ...        0         0 2019-09-06     361.75   \n",
      "\n",
      "       STOCK_HIGH STOCK_LOW STOCK_CLOSE STOCK_TOTTRDQTY STOCK_DELIVERABLE  \\\n",
      "0         1503.95    1440.0      1451.3         1309422            567551   \n",
      "1         1503.95    1440.0      1451.3         1309422            567551   \n",
      "2         1503.95    1440.0      1451.3         1309422            567551   \n",
      "3         1503.95    1440.0      1451.3         1309422            567551   \n",
      "4         1503.95    1440.0      1451.3         1309422            567551   \n",
      "...           ...       ...         ...             ...               ...   \n",
      "122519      366.8    358.65      361.25         2378166            395918   \n",
      "122520      366.8    358.65      361.25         2378166            395918   \n",
      "122521      366.8    358.65      361.25         2378166            395918   \n",
      "122522      366.8    358.65      361.25         2378166            395918   \n",
      "122523      366.8    358.65      361.25         2378166            395918   \n",
      "\n",
      "       DAYS_TO_EXP  \n",
      "0               23  \n",
      "1               23  \n",
      "2               23  \n",
      "3               23  \n",
      "4               23  \n",
      "...            ...  \n",
      "122519          83  \n",
      "122520          83  \n",
      "122521          83  \n",
      "122522          83  \n",
      "122523          83  \n",
      "\n",
      "[122524 rows x 22 columns]\n"
     ]
    }
   ],
   "source": [
    "result_data['DAYS_TO_EXP']=result_data.apply(compute_DAYS_TO_EXP, axis=1)\n",
    "print(result_data)\n",
    "result_data['IV'] = result_data.apply(compute_IV, axis=1)\n",
    "print(result_data)\n",
    "\n",
    "result_data['DELTA'] = result_data.apply(compute_DELTA, axis=1)\n",
    "print(result_data)\n",
    "\n",
    "result_data['MONEY'] = result_data.apply(compute_MONEY, axis=1)\n",
    "print(result_data)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c3cf3ebf",
   "metadata": {},
   "outputs": [],
   "source": [
    "result_data.to_csv('/Users/ashutoshaggawal27/Documents/Term4/ProjectCourse/Term4Options/dataset/options_with_greeks', encoding='utf-8', index=False)\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
